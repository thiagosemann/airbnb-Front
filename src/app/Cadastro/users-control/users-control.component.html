<!-- users-control.component.html -->
<div class="containerAux py-3">
  <!-- Cabeçalho + SearchBar em mobile -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
   <div style="margin-right: 15px;">
      <h2 class="mb-2 mb-md-0">Usuários</h2>
   </div>
    <div class="d-flex flex-column flex-md-row w-100 w-md-auto align-items-stretch align-items-md-center gap-2">
      <div class="search-container-desktop position-relative me-md-2 flex-grow-1">
        <i class="fas fa-search search-icon position-absolute"></i>
        <input 
          type="text" 
          class="form-control search-input ps-4" 
          placeholder="    Pesquisar por nome, CPF, telefone ou email..."
          [(ngModel)]="searchTerm"
          (input)="filtrar()">

      </div>
      <button class="btn btn-primary d-flex align-items-center justify-content-center" (click)="abrirModal()">
        <i class="fas fa-plus me-2"></i>Novo Usuário
      </button>
    </div>
  </div>

  <!-- Lista de cards (xs–md) -->
  <div class="row row-cols-1 row-cols-sm-2 g-3 d-block d-md-flex flex-md-wrap d-md-none">
    <div *ngFor="let user of filteredUsers" class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ user.first_name }} {{ user.last_name }}</h5>
            <span class="badge bg-success-subtle text-success ms-2">
              {{ user.role | titlecase }}
            </span>
          </div>
          <ul class="list-unstyled small mb-3">
            <li><i class="fas fa-id-card me-1 text-secondary"></i>{{ formatCPF(user.cpf) }}</li>
            <li><i class="fas fa-phone me-1 text-secondary"></i>{{ formtarTelefone(user.Telefone) }}</li>
            <li><i class="fas fa-envelope me-1 text-secondary"></i>{{ user.email }}</li>
          </ul>
          <div class="d-flex justify-content-end gap-1">
            <button class="btn btn-sm btn-outline-primary" (click)="editarUsuario(user)" title="Editar usuário">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="excluirUsuario(user.id!)" title="Excluir usuário">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="!filteredUsers.length" class="col-12 text-center py-4 text-muted">
      Nenhum usuário encontrado.
    </div>
  </div>

  <!-- Tabela para telas maiores -->
  <div class="table-wrapper d-none d-md-block">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Nome</th>
            <th>CPF</th>
            <th>Telefone</th>
            <th>Tipo</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers">
            <td class="fw-medium">{{ user.first_name }} {{ user.last_name }}</td>
            <td>{{ formatCPF(user.cpf) }}</td>
            <td>{{ formtarTelefone(user.Telefone) }}</td>
            <td>
              <span class="badge bg-success-subtle text-success">
                {{ user.role | titlecase }}
              </span>
            </td>
            <td class="text-end">
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-outline-primary" (click)="editarUsuario(user)" title="Editar usuário">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="excluirUsuario(user.id!)" title="Excluir usuário">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!filteredUsers.length">
            <td colspan="5" class="text-center py-4 text-muted">
              Nenhum usuário encontrado.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal (mantido igual) -->
  <div class="modal" *ngIf="showModal">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h3 class="mb-0">{{ isEditing ? 'Editar Usuário' : 'Novo Usuário' }}</h3>
        <button class="close-btn" (click)="fecharModal()">×</button>
      </div>
      <div class="modal-body">
        <div *ngIf="isLoading" class="d-flex justify-content-center my-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>

        <form *ngIf="!isLoading" [formGroup]="userForm" class="row g-3">
          <!-- Seção 1: Informações Pessoais -->
          <div class="col-md-6">
            <div class="section-header mb-3">
              <h5 class="section-title"><i class="fas fa-user-circle me-2"></i>Informações Pessoais</h5>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-medium">Nome</label>
              <input type="text" class="form-control border-success" formControlName="first_name">
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-medium">Sobrenome</label>
              <input type="text" class="form-control border-success" formControlName="last_name">
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">CPF</label>
              <input type="text" class="form-control border-success" 
                    formControlName="cpf" mask="000.000.000-00">
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Telefone</label>
              <input type="text" class="form-control border-success" 
                    formControlName="Telefone" mask="(00) 00000-0000">
            </div>
            <div class="mb-3">
              <label class="form-label fw-medium">Email</label>
              <input type="text" class="form-control border-success" 
                    formControlName="email" >
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Tipo de Usuário</label>
              <select 
                class="form-select border-success" 
                formControlName="role"
                [disabled]="user?.empresa_id !== 1">
                <option *ngIf="user?.empresa_id === 1" value="guest">Hóspede</option>
                <option *ngIf="user?.empresa_id === 1" value="admin">Administrador</option>
                <option value="terceirizado">Limpeza</option>
              </select>
            </div>
          </div>

          <!-- Seção 2: Documentos – somente em edição -->
          <div class="col-md-6" *ngIf="isEditing">
            <div class="section-header mb-3">
              <h5 class="section-title"><i class="fas fa-file-alt me-2"></i>Documentos</h5>
            </div>

            <div class="row g-3">
              <!-- Selfie -->
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label fw-medium">Selfie</label>
                  <div *ngIf="userForm.get('imagemBase64')?.value; else noImage">
                    <img [src]="'data:image/png;base64,' + userForm.get('imagemBase64')?.value"
                        alt="Selfie do usuário"
                        class="img-fluid rounded shadow-sm">
                  </div>
                  <ng-template #noImage>
                    <p class="text-muted small">Nenhuma selfie cadastrada.</p>
                  </ng-template>
                </div>
              </div>

              <!-- Documento -->
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label fw-medium">Documento</label>
                  <div *ngIf="userForm.get('documentBase64')?.value; else noDoc">
                    <ng-container *ngIf="!isPDF(userForm.get('documentBase64')?.value); else pdfDoc">
                      <img [src]="'data:image/png;base64,' + userForm.get('documentBase64')?.value"
                          alt="Documento do usuário"
                          class="img-fluid rounded shadow-sm">
                    </ng-container>
                    <ng-template #pdfDoc>
                      <iframe [src]="getSafeUrl(userForm.get('documentBase64')?.value)"
                              class="w-100 rounded"
                              style="height: 120px;"></iframe>
                    </ng-template>
                  </div>
                  <ng-template #noDoc>
                    <p class="text-muted small">Nenhum documento cadastrado.</p>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Seção 3: Check-ins realizados – somente em edição -->
          <div class="col-12" *ngIf="isEditing">
            <div class="section-header mb-3">
              <h5 class="section-title">
                <i class="fas fa-clipboard-list me-2"></i>Check-ins Realizados
              </h5>
            </div>

            <div *ngIf="userCheckins.length; else noCheckins">
              <div >
                <table class="table table-bordered align-middle mb-0">
                  <thead class="table-success">
                    <tr>
                      <th>Cod Reserva</th>
                      <th>Apartamento ID</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let ci of userCheckins">
                      <td>{{ ci.cod_reserva }}</td>
                      <td>{{ ci.apartamento_id }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <ng-template #noCheckins>
              <p class="text-muted small">Este usuário ainda não realizou nenhum check-in.</p>
            </ng-template>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="fecharModal()">Cancelar</button>
        <button class="btn btn-success" (click)="salvarUsuario()" >
          <i class="fas fa-save me-2"></i>{{ isEditing ? 'Atualizar' : 'Salvar' }}
        </button>
      </div>
    </div>
  </div>
</div>