<!-- cadastro-proprietarios.component.html -->
<div class="container">
  <div class="header-card">
    <div class="header-title">
      <i class="bi bi-people-fill"></i>
      <h1>Proprietários</h1>
    </div>
    
    <div class="header-actions">
      <div class="search-container">
        <i class="bi bi-search"></i>
        <input 
          type="text" 
          placeholder="Pesquisar proprietários..."
          [(ngModel)]="searchTerm"
          (input)="filtrar()"
        >
      </div>
      <button class="btn-add" (click)="abrirModal()">
        <i class="bi bi-plus-lg"></i> Novo Proprietário
      </button>
      <button class="btn-add" (click)="exportApartamentosPorProprietario()" title="Exportar CSV">
        <i class="bi bi-download"></i> Exportar CSV
      </button>
    </div>
  </div>

  <!-- Tabela para desktop -->
  <div class="alert-unlinked" *ngIf="apartamentosSemProprietario.length">
    <button class="unlinked-toggle" (click)="showUnlinked = !showUnlinked">
      <div class="pulse-dot"></div>
      <div class="unlinked-heading">
        <span>APARTAMENTOS SEM PROPRIETÁRIOS <strong class="badge-count">({{ apartamentosSemProprietario.length }})</strong></span>
        <small>Resolva para evitar falhas de controle</small>
      </div>
      <i class="bi" [ngClass]="{ 'bi-chevron-up': showUnlinked, 'bi-chevron-down': !showUnlinked }"></i>
    </button>

    <div class="unlinked-panel" *ngIf="showUnlinked">
      <div class="unlinked-list">
        <div class="unlinked-item" *ngFor="let apto of apartamentosSemProprietario">
          <div class="unlinked-info">
            <strong>{{ apto.nome }}</strong>
          </div>
          <div class="unlinked-actions">
            <select [(ngModel)]="selectedProprietarioPorApto[apto.id]" [ngModelOptions]="{standalone: true}">
              <option [ngValue]="null">Selecione um proprietário</option>
              <option *ngFor="let prop of users" [ngValue]="prop.id">
                {{ prop.first_name }} {{ prop.last_name }}
              </option>
            </select>
            <button class="btn-link" (click)="vincularApartamentoSemProprietario(apto.id)">
              Vincular
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-none d-md-block">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-header">
          <tr>
            <th>
              <button class="th-sort" [class.active]="sortKey === 'nome'" (click)="changeSort('nome')">
                Nome
                <i class="bi" [ngClass]="{
                  'bi-caret-up-fill': sortKey === 'nome' && sortDir === 'asc',
                  'bi-caret-down-fill': sortKey === 'nome' && sortDir === 'desc',
                  'bi-caret-up': sortKey !== 'nome'
                }"></i>
              </button>
            </th>
            <th>CPF/CNPJ</th>
            <th>Telefone</th>
            <th>
              <button class="th-sort" [class.active]="sortKey === 'qtd'" (click)="changeSort('qtd')">
                Quantidade Apartamentos
                <i class="bi" [ngClass]="{
                  'bi-caret-up-fill': sortKey === 'qtd' && sortDir === 'asc',
                  'bi-caret-down-fill': sortKey === 'qtd' && sortDir === 'desc',
                  'bi-caret-up': sortKey !== 'qtd'
                }"></i>
              </button>
            </th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers">
            <td>{{ user.first_name }} {{ user.last_name }}</td>
            <td>{{ formatCPF(user.cpf) }}</td>
            <td>{{ formtarTelefone(user.Telefone) }}</td>
            <td>
              <span class="badge-apto" [class.empty]="!((user.qtd_apartamentos ?? 0) > 0)">
                {{ user.qtd_apartamentos ?? 0 }} apartamento{{ (user.qtd_apartamentos ?? 0) === 1 ? '' : 's' }}
              </span>
            </td>
            <td>
              <div class="actions">
                <button class="btn-edit" (click)="editarUsuario(user)" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn-delete" (click)="excluirUsuario(user.id!)" title="Excluir">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredUsers.length === 0">
            <td colspan="5" class="no-results-table">
              <i class="bi bi-people"></i>
              Nenhum proprietário encontrado
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Cards para mobile -->
  <div class="users-grid d-block d-md-none">
    <div *ngFor="let user of filteredUsers" class="user-card">
      <div class="user-header">
        <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
        <div class="user-cpf">{{ formatCPF(user.cpf) }}</div>
      </div>
      
      <div class="user-details">
        <div class="detail-item">
          <i class="bi bi-telephone"></i>
          {{ formtarTelefone(user.Telefone) }}
        </div>
        <div class="detail-item">
          <i class="bi bi-envelope"></i>
          {{ user.email || 'Não informado' }}
        </div>
        <div class="detail-item highlight">
          <i class="bi bi-building"></i>
          {{ user.qtd_apartamentos ?? 0 }} apartamento{{ (user.qtd_apartamentos ?? 0) === 1 ? '' : 's' }}
        </div>
      </div>
      
      <div class="user-actions">
        <button class="btn-edit" (click)="editarUsuario(user)" title="Editar">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn-delete" (click)="excluirUsuario(user.id!)" title="Excluir">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
    
    <div *ngIf="filteredUsers.length === 0" class="no-results">
      <i class="bi bi-people"></i>
      <p>Nenhum proprietário encontrado</p>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" *ngIf="showModal" (click)="fecharModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditing ? 'Editar Proprietário' : 'Novo Proprietário' }}</h2>
        <button class="modal-close" (click)="fecharModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div *ngIf="isLoading" class="loading-indicator">
          <div class="spinner"></div>
          <p>Carregando informações...</p>
        </div>
        
        <form *ngIf="!isLoading" [formGroup]="userForm">
          <!-- Informações Pessoais -->
          <div class="form-section">
            <h3><i class="bi bi-person-circle"></i> Informações Pessoais</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label>Nome *</label>
                <input type="text" formControlName="first_name" placeholder="Nome do proprietário">
              </div>
              
              <div class="form-group">
                <label>Sobrenome</label>
                <input type="text" formControlName="last_name" placeholder="Sobrenome">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>CPF/CNPJ *</label>
                <input type="text" formControlName="cpf" mask="000.000.000-00||00.000.000/0000-00" placeholder="000.000.000-00 ou 00.000.000/0000-00">
              </div>
              
              <div class="form-group">
                <label>Telefone *</label>
                <input type="text" formControlName="Telefone" mask="(00) 00000-0000" placeholder="(00) 00000-0000">
              </div>
            </div>
            
            <div class="form-group">
              <label>Email</label>
              <input type="email" formControlName="email" placeholder="email@exemplo.com">
            </div>
          </div>
          
          <!-- Apartamentos Vinculados -->
          <div class="form-section">
            <h3><i class="bi bi-building"></i> Apartamentos Vinculados</h3>
            
            <!-- Campo de pesquisa para apartamentos -->
            <div class="apto-search-container">
              <i class="bi bi-search"></i>
              <input 
                type="text" 
                placeholder="Pesquisar apartamentos..."
                [(ngModel)]="searchAptoTerm"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="filtrarApartamentos()"
              >
              <button class="btn-clear-search" *ngIf="searchAptoTerm" (click)="limparPesquisaAptos()">
                <i class="bi bi-x"></i>
              </button>
            </div>
            
            <div class="apartamentos-container">
              <div *ngFor="let apto of apartamentosFiltrados" class="apartamento-item">
                <input 
                  type="checkbox" 
                  [id]="'apto-' + apto.id"
                  [checked]="apartamentosSelecionados.includes(apto.id)"
                  (change)="toggleAptoSelection(apto.id)"
                >
                <label [for]="'apto-' + apto.id">
                  {{ apto.nome }} <span>(ID: {{ apto.id }})</span>
                </label>
              </div>
              
              <div *ngIf="apartamentosFiltrados.length === 0" class="no-apartamentos">
                Nenhum apartamento encontrado
              </div>
            </div>
          </div>
          
          <!-- Documentos (só em edição) -->
          <div *ngIf="isEditing" class="form-section">
            <h3><i class="bi bi-file-earmark"></i> Documentos</h3>
            
            <div class="document-preview">
              <div *ngIf="userForm.get('imagemBase64')?.value; else noImage">
                <img [src]="'data:image/png;base64,' + userForm.get('imagemBase64')?.value" alt="Selfie do usuário">
              </div>
              <ng-template #noImage>
                <div class="no-document">
                  <i class="bi bi-image"></i>
                  <p>Nenhuma selfie cadastrada</p>
                </div>
              </ng-template>
            </div>
          </div>
          
          <!-- Check-ins (só em edição) -->
          <div *ngIf="isEditing && userCheckins.length" class="form-section">
            <h3><i class="bi bi-clipboard-check"></i> Check-ins Realizados</h3>
            
            <div class="checkins-container">
              <div *ngFor="let ci of userCheckins" class="checkin-item">
                <div class="checkin-info">
                  <div><strong>Cód. Reserva:</strong> {{ ci.cod_reserva }}</div>
                  <div><strong>Apartamento:</strong> {{ getAptoName(ci.apartamento_id) }}</div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn-cancel" (click)="fecharModal()">Cancelar</button>
        <button class="btn-save" (click)="salvarUsuario()">
          {{ isEditing ? 'Atualizar' : 'Salvar' }}
        </button>
      </div>
    </div>
  </div>
</div>