<div class="migrar-ical-wrapper">
	<h2>Migrar iCal - Reservas por Apartamento</h2>

	<!-- Seleção de Apartamento -->
	<div class="apto-select">
		<label for="apartamentoSelect">Apartamento:</label>
		<select id="apartamentoSelect" (change)="onSelectApartamentoEvent($event)" [disabled]="loadingApartamentos">
			<option value="">-- selecione --</option>
			<option *ngFor="let ap of apartamentos" [value]="ap.id">
				{{ ap.nome_anuncio || ap.nome }} (ID: {{ ap.id }})
			</option>
		</select>
		<span *ngIf="loadingApartamentos" class="loading">Carregando apartamentos...</span>
	</div>

	<div *ngIf="errorMsg" class="error">{{ errorMsg }}</div>

	<!-- Primeira Tabela (Reservas) -->
	<div class="tables-container">
		<div class="table-half">
			<h3>Reservas do Apartamento</h3>
			<div class="migrate-bar" *ngIf="selectedSourceId || selectedTargetId">
				<button type="button" (click)="onMigrateSelected()" [disabled]="!(selectedSourceId && selectedTargetId)" class="btn-migrate">Migrar seleção</button>
				<span class="match-indicator" *ngIf="selectedSourceId && selectedTargetId">
					<ng-container *ngIf="selectedDatesMatch(); else noMatch">Datas coincidem ✔</ng-container>
					<ng-template #noMatch>Datas diferentes ⚠</ng-template>
				</span>
			</div>

			<!-- Legenda visual -->
			<div class="legend">
				<span class="legend-item">
					<span class="legend-box box-selected"></span>
					Selecionado
				</span>
				<span class="legend-item">
					<span class="legend-box box-match"></span>
					Período com match
				</span>
				<span class="legend-item">
					<span class="legend-box box-nomatch"></span>
					Sem match
				</span>
			</div>
			<div *ngIf="loadingReservas" class="loading">Carregando reservas...</div>
				<div class="table-scroll" *ngIf="!loadingReservas && reservasSemAyrton.length > 0">
					<table class="reservas-table">
						<thead>
							<tr>
								<th>Cod</th>
								<th>Início</th>
								<th>Fim</th>
								<th>Noites</th>
								<th>Hóspedes</th>
								<th>Descrição</th>
								<th>Observações</th>
								<th>Ações</th>
							</tr>
						</thead>
						<tbody>
									<tr *ngFor="let r of reservasSemAyrton"
										[class.row-selected]="r.id===selectedSourceId"
										[class.has-match]="hasMatch(r)"
										[class.no-match]="!hasMatch(r)"
										[class.match-with-target]="selectedTarget && isSameDateRange(r, selectedTarget)"
									>
								<td>{{ r.cod_reserva }}</td>
								<td>{{ r.start_date | date:'dd/MM/yyyy' }}</td>
								<td>{{ r.end_data | date:'dd/MM/yyyy' }}</td>
								<td>{{ calcNoites(r.start_date, r.end_data) }}</td>
												<td>
												<ng-container *ngIf="!carregandoCheckins; else loadingHospedes">
											<span class="chip chip-count" title="nº de check-ins">{{ totalHospedesReserva(r) || '-' }}</span>
												</ng-container>
												<ng-template #loadingHospedes>
													<span class="loading">calculando...</span>
												</ng-template>
											</td>
								<td>{{ r.description }}</td>
											<td>
												<div>{{ r.Observacoes }}</div>
										<div class="checkin-ids" *ngIf="checkinIdsReserva(r).length > 0">
											<span class="chip chip-id" *ngFor="let id of checkinIdsReserva(r)" title="check-in #{{id}}">#{{ id }}</span>
										</div>
												</td>
										<td class="actions">
											<button type="button" (click)="onSelectSource(r)" class="btn-select" [disabled]="carregandoCheckins">Selecionar</button>
											<div class="match-count" *ngIf="getAyrtonMatchesFor(r).length>0">{{ getAyrtonMatchesFor(r).length }} match(s)</div>
											<button *ngFor="let m of getAyrtonMatchesFor(r)" type="button" (click)="onMigratePair(r,m)" class="btn-quick" title="Migrar direto para {{m.cod_reserva}}" [disabled]="carregandoCheckins">→ {{ m.cod_reserva }}</button>
										</td>
							</tr>
						</tbody>
					</table>
				</div>
			<div *ngIf="!loadingReservas && reservasSemAyrton.length === 0 && selectedApartamentoId" class="empty">Nenhuma reserva encontrada.</div>
			<div *ngIf="!selectedApartamentoId" class="hint">Selecione um apartamento para ver as reservas.</div>
		</div>

		<!-- Segunda tabela: Reservas com AYRTON no código -->
		<div class="table-half">
			<h3>Reservas AYRTON</h3>
			<div class="table-scroll" *ngIf="!loadingReservas && reservasAyrton.length > 0; else emptyAyrton">
				<table class="reservas-table">
					<thead>
						<tr>
							<th>Cod</th>
							<th>Início</th>
							<th>Fim</th>
							<th>Noites</th>
							<th>Hóspedes</th>
							<th>Descrição</th>
							<th>Observações</th>
							<th>Ações</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let r of reservasAyrton" [class.row-selected]="r.id===selectedTargetId" [class.match-with-source]="selectedSource && isSameDateRange(selectedSource, r)">
							<td><span class="badge-ayrton">{{ r.cod_reserva }}</span></td>
							<td>{{ r.start_date | date:'dd/MM/yyyy' }}</td>
							<td>{{ r.end_data | date:'dd/MM/yyyy' }}</td>
							<td>{{ calcNoites(r.start_date, r.end_data) }}</td>
							<td>
								<ng-container *ngIf="!carregandoCheckins; else loadingHospedes2">
									<span class="chip chip-count" title="nº de check-ins">{{ totalHospedesReserva(r) || '-' }}</span>
								</ng-container>
								<ng-template #loadingHospedes2>
									<span class="loading">calculando...</span>
								</ng-template>
							</td>
							<td>{{ r.description }}</td>
							<td>
								<div>{{ r.Observacoes }}</div>
								<div class="checkin-ids" *ngIf="checkinIdsReserva(r).length > 0">
									<span class="chip chip-id" *ngFor="let id of checkinIdsReserva(r)" title="check-in #{{id}}">#{{ id }}</span>
								</div>
							</td>
							<td class="actions">
								<button type="button" (click)="onSelectTarget(r)" class="btn-select" [disabled]="carregandoCheckins">Destino</button>
								<span class="date-indicator">{{ r.start_date | date:'dd/MM' }} - {{ r.end_data | date:'dd/MM' }}</span>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<ng-template #emptyAyrton>
				<div class="empty">Nenhuma reserva AYRTON.</div>
			</ng-template>
		</div>
	</div>
</div>
