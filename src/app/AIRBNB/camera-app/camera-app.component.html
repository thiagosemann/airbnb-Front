<div class="main-wrapper">


  <!-- Step 1: Identificação -->
  <div class="app-card" *ngIf="step === 1">
    <header>
      <div class="logo-container">
        <div class="logo-row">
          <span class="material-icons-round logo-icon">eco</span>
          <span class="logo-text">forest</span>
        </div>
        <p class="logo-tagline">{{ t.tagline }}</p>
      </div>
    </header>

    <main>
      <div class="info-card">
        <div>
          <p class="info-label">{{ t.codeLabel }}</p>
          <p class="info-value">{{ id }}</p>
        </div>
        <span class="material-icons-round" style="color: rgba(100,163,95,0.4);">confirmation_number</span>
      </div>

      <div class="mb-8" style="margin-bottom: 2rem;">
        <h1 class="step-title">{{ t.step1Title }}</h1>
        <div class="step-dots">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>

      <form (ngSubmit)="goForward()">
        <div class="toggle-row">
          <label class="info-label" style="font-size: 0.875rem; color: var(--text-main);">{{ t.foreignerLabel }}</label>
          <label class="switch">
            <input type="checkbox" [(ngModel)]="souEstrangeiro" name="souEstrangeiro">
            <span class="slider"></span>
          </label>
        </div>

        <div class="form-group">
          <label class="input-label">{{ t.nameLabel }}</label>
          <input type="text" class="input-field" [placeholder]="t.namePlaceholder" [(ngModel)]="formData.nome"
            name="nome" required>
        </div>

        <div class="form-group" *ngIf="!souEstrangeiro">
          <label class="input-label">{{ t.cpfLabel }}</label>
          <input type="text" class="input-field" [placeholder]="t.cpfPlaceholder" mask="000.000.000-00"
            [(ngModel)]="formData.cpf" name="cpf" required>
        </div>

        <div class="form-group" *ngIf="souEstrangeiro">
          <label class="input-label">{{ t.passportLabel }}</label>
          <input type="text" class="input-field" [placeholder]="t.passportPlaceholder" [(ngModel)]="formData.cpf"
            name="passport" required>
        </div>

        <div class="form-group">
          <label class="input-label">{{ t.phoneLabel }}</label>
          <input type="tel" class="input-field" [placeholder]="t.phonePlaceholder" mask="(00) 00000-0000"
            [(ngModel)]="formData.telefone" name="telefone" required>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
          <label class="input-label">{{ t.arrivalLabel }}</label>

          <div style="margin-top: 1rem;">
            <!-- Tarde -->
            <div *ngIf="afternoonHours.length > 0">
              <p class="time-group-label" style="margin-top: 1rem;">{{ t.afternoonLabel }}</p>
              <div class="chips-scroll">
                <button type="button" class="time-chip" *ngFor="let hour of afternoonHours"
                  [class.selected]="formData.horarioPrevistoChegada === hour" (click)="selectHour(hour)">
                  {{ hour }}
                </button>
              </div>
            </div>

            <!-- Noite -->
            <div *ngIf="nightHours.length > 0">
              <p class="time-group-label" style="margin-top: 1rem;">{{ t.nightLabel }}</p>
              <div class="chips-scroll">
                <button type="button" class="time-chip" *ngFor="let hour of nightHours"
                  [class.selected]="formData.horarioPrevistoChegada === hour" (click)="selectHour(hour)">
                  {{ hour }}
                </button>
              </div>
            </div>

            <!-- Madrugada -->
            <div *ngIf="earlyMorningHours.length > 0">
              <p class="time-group-label" style="margin-top: 1rem;">{{ t.earlyMorningLabel }}</p>
              <div class="chips-scroll">
                <button type="button" class="time-chip" *ngFor="let hour of earlyMorningHours"
                  [class.selected]="formData.horarioPrevistoChegada === hour" (click)="selectHour(hour)">
                  {{ hour }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </main>

    <footer>
      <div class="legal-box">
        <span class="material-icons-round" style="color: var(--primary); font-size: 1.25rem;">info</span>
        <p class="legal-text">
          {{ t.legalText1 }}
        </p>
      </div>

      <button class="btn-primary" (click)="goForward()">
        <span>{{ t.nextStep }}</span>
        <span class="material-icons-round">arrow_forward</span>
      </button>
    </footer>
  </div>


  <!-- Step 2: Uploads -->
  <div class="app-card" *ngIf="step === 2">
    <header style="padding-bottom: 0.5rem;">
      <div class="logo-row">
        <span class="material-icons-round logo-icon" style="font-size: 1.5rem;">eco</span>
        <div style="display: flex; flex-direction: column;">
          <span class="logo-text" style="font-size: 1.25rem;">forest</span>
          <span class="logo-tagline" style="font-size: 0.5rem;">{{ t.tagline }}</span>
        </div>
      </div>
    </header>

    <main>
      <h1 class="step-title" style="color: var(--primary); font-size: 1.25rem; margin-top: 1rem;">{{ t.step2Title }}
      </h1>
      <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1.5rem;">{{ t.step2Subtitle }}</p>

      <div class="legal-box" style="margin-bottom: 1.5rem;">
        <span class="material-icons-round" style="color: var(--primary);">info</span>
        <div class="legal-text">
          {{ t.uploadInstruction }}<br>
          <span *ngIf="pedir_selfie">• <strong>{{ t.selfieItem }}</strong> {{ t.selfieDesc }}<br></span>
          • <strong>{{ t.docItem }}</strong> {{ t.docDesc }}
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 1.5rem;">

        <!-- Selfie Upload -->
        <div *ngIf="pedir_selfie">
          <div class="upload-header">
            <div class="step-label">
              <div class="step-badge">1</div>
              <span>{{ t.selfieLabel }}</span>
            </div>
            <span class="status-badge" [class.ok]="photoDataUrl">{{ photoDataUrl ? t.sent : t.pending }}</span>
          </div>

          <div class="upload-box" *ngIf="!photoDataUrl">
            <span class="material-icons-round"
              style="font-size: 2rem; color: #9ca3af; margin-bottom: 0.5rem;">add_a_photo</span>
            <p style="font-size: 0.75rem; color: var(--text-muted);">{{ t.takePhoto }}</p>
            <input type="file" accept="image/*,application/pdf" (change)="onSelfieSelected($event)">
          </div>

          <div class="file-preview-row" *ngIf="photoDataUrl">
            <div class="thumb-preview">
              <img *ngIf="photoDataUrl.startsWith('data:image')" [src]="photoDataUrl" alt="Selfie">
              <img *ngIf="photoDataUrl.startsWith('data:application/pdf')" src="../../../assets/images/PDF.png"
                alt="PDF">
            </div>
            <div style="flex: 1;">
              <p style="font-size: 0.875rem; font-weight: 600; color: var(--text-main);">{{ t.selfieSent }}</p>
              <p style="font-size: 0.75rem; color: var(--text-muted);">{{ t.readyToSend }}</p>
            </div>
            <button (click)="photoDataUrl=null" style="background:none; border:none; color: #ef4444; cursor: pointer;">
              <span class="material-icons-round">delete_outline</span>
            </button>
          </div>
        </div>

        <!-- Document Upload -->
        <div>
          <div class="upload-header">
            <div class="step-label">
              <div class="step-badge">{{ pedir_selfie ? '2' : '1' }}</div>
              <span>{{ t.docLabel }}</span>
            </div>
            <span class="status-badge" [class.ok]="documentFile">{{ documentFile ? t.sent : t.pending }}</span>
          </div>

          <div class="upload-box" *ngIf="!documentFile">
            <span class="material-icons-round"
              style="font-size: 2rem; color: #9ca3af; margin-bottom: 0.5rem;">badge</span>
            <p style="font-size: 0.75rem; color: var(--text-muted);">{{ t.selectDoc }}</p>
            <input type="file" accept="image/*,application/pdf" (change)="onFileSelected($event)">
          </div>

          <div class="file-preview-row" *ngIf="documentFile">
            <div class="thumb-preview">
              <img *ngIf="documentFile.startsWith('data:image')" [src]="documentFile" alt="Doc">
              <img *ngIf="documentFile.startsWith('data:application/pdf')" src="../../../assets/images/PDF.png"
                alt="PDF">
            </div>
            <div style="flex: 1;">
              <p style="font-size: 0.875rem; font-weight: 600; color: var(--text-main);">{{ t.docLoaded }}</p>
            </div>
            <button (click)="documentFile=null" style="background:none; border:none; color: #ef4444; cursor: pointer;">
              <span class="material-icons-round">delete_outline</span>
            </button>
          </div>
        </div>

        <!-- Placa (Mandatory if tem_garagem) -->
        <div *ngIf="tem_garagem">
          <!-- Toggle para utilizar a vaga -->
          <div style="margin-bottom: 1.5rem;">
            <div class="toggle-row">
              <label class="info-label" style="font-size: 0.875rem; color: var(--text-main);">{{ t.useGarageLabel
                }}</label>
              <label class="switch">
                <input type="checkbox" [(ngModel)]="usarGaragem" name="usarGaragem">
                <span class="slider"></span>
              </label>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; line-height: 1.4;">{{
              t.useGarageHint }}</p>
          </div>

          <div *ngIf="usarGaragem">
            <div class="form-group">
              <label class="input-label">{{ t.plateLabel }}</label>
              <div style="position: relative;">
                <span class="material-icons-round"
                  style="position: absolute; left: 1rem; top: 1rem; color: #9ca3af;">directions_car</span>
                <input type="text" class="input-field" style="padding-left: 3rem;" [placeholder]="t.platePlaceholder"
                  [(ngModel)]="placaCarro">
              </div>
            </div>
            <div class="form-group">
              <label class="input-label">{{ t.marcaLabel }}</label>
              <input type="text" class="input-field" [placeholder]="t.marcaPlaceholder" [(ngModel)]="marcaCarro">
            </div>
            <div class="form-group">
              <label class="input-label">{{ t.modeloLabel }}</label>
              <input type="text" class="input-field" [placeholder]="t.modeloPlaceholder" [(ngModel)]="modeloCarro">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label class="input-label">{{ t.corLabel }}</label>
              <input type="text" class="input-field" [placeholder]="t.corPlaceholder" [(ngModel)]="corCarro">
              <p style="font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem;">{{ t.plateHint }}</p>
            </div>
          </div>
        </div>

      </div>
    </main>

    <footer style="margin-top: 2rem;">
      <button class="btn-primary" (click)="sendData()" [disabled]="(pedir_selfie && !photoDataUrl) || !documentFile">
        <span>{{ t.sendDocs }}</span>
        <span class="material-icons-round">arrow_forward</span>
      </button>
      <button class="btn-secondary" (click)="goBack()">
        <span class="material-icons-round">arrow_back</span>
        {{ t.back }}
      </button>

      <div style="display: flex; justify-content: center; margin-top: 1rem;">
        <div class="step-dots">
          <div class="dot active" style="width: 8rem; opacity: 0.5;"></div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Step 4: Loading -->
  <div class="app-card" *ngIf="step === 4" style="justify-content: center;">
    <div class="loader-wrapper">
      <div class="loader-spinner"></div>
      <h2 class="step-title" style="text-align: center;">{{ t.processing }}</h2>
    </div>
  </div>

  <!-- Step 5/6: Success -->
  <div class="app-card" *ngIf="step === 5 || step === 6">
    <header style="padding-bottom: 1rem;">
      <div class="logo-row">
        <span class="material-icons-round logo-icon">eco</span>
        <div style="display: flex; flex-direction: column;">
          <span class="logo-text">forest</span>
          <span class="logo-tagline">{{ t.tagline }}</span>
        </div>
      </div>
    </header>

    <div class="success-container">
      <div class="success-checkmark">
        <div class="check-icon">
          <span class="icon-line line-tip"></span>
          <span class="icon-line line-long"></span>
        </div>
      </div>

      <h1 class="success-title">{{ t.successTitle }}</h1>
      <p class="success-text" style="max-width: 80%;" [innerHTML]="t.successText">
      </p>

      <div class="legal-box" style="margin-top: 2rem; width: 80%;">
        <span class="material-icons-round" style="color: var(--primary);">info</span>
        <p class="legal-text">
          {{ t.legalText2 }}
        </p>
      </div>
    </div>

    <footer style="margin-bottom: 2rem;">
      <button class="btn-outline" (click)="resetFlow()">
        {{ t.registerAnother }}
      </button>
      <button class="btn-primary" (click)="concluirCadastro()">
        {{ t.finish }}
      </button>
    </footer>
  </div>

  <!-- Botão flutuante do WhatsApp -->
  <a href="https://wa.me/5541999283936" class="whatsapp-float" target="_blank" aria-label="Fale conosco no WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>
</div>